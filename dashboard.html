<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OPCO : TWF 이벤트 심사 시스템</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#00897B",
            "primary-hover": "#00695C",
            "primary-light": "#E0F2F1",
            "background-light": "#F8FAFC",
            "background-dark": "#0F172A",
            "surface-light": "#FFFFFF",
            "surface-dark": "#1E293B",
            "text-main": "#0F172A",
            "text-muted": "#64748B",
            "border-light": "#E2E8F0",
          },
          fontFamily: {
            sans: ["Noto Sans KR", "Inter", "sans-serif"],
            mono: ["JetBrains Mono", "monospace"],
          },
        },
      },
    };
  </script>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-main dark:text-gray-100 min-h-screen flex flex-col">
  <header class="bg-surface-light dark:bg-surface-dark border-b border-border-light dark:border-gray-700 sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center gap-4">
          <div class="flex-shrink-0 flex items-center gap-2">
            <div class="w-8 h-8 bg-primary rounded flex items-center justify-center text-white">
              <span class="material-symbols-outlined text-xl">precision_manufacturing</span>
            </div>
            <span class="font-bold text-lg tracking-tight text-text-main dark:text-white">OPCO : TWF</span>
          </div>
          <div class="hidden md:flex h-6 w-px bg-border-light mx-2"></div>
          <nav class="hidden md:flex space-x-4">
            <a class="text-text-main dark:text-white px-3 py-2 rounded-md text-sm font-medium bg-background-light dark:bg-gray-800" href="dashboard.html">이벤트 목록</a>
            <a class="text-text-muted hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-colors" href="mypage.html">마이페이지</a>
            <a class="admin-only-tab hidden text-text-muted hover:text-primary px-3 py-2 rounded-md text-sm font-medium transition-colors" href="admin.html">관리자</a>
          </nav>
        </div>
        <div class="flex items-center gap-4">
          <button class="p-2 rounded-full text-text-muted hover:bg-background-light transition-colors relative">
            <span class="material-symbols-outlined text-[20px]">notifications</span>
            <span class="absolute top-2 right-2 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white"></span>
          </button>
          <div class="h-6 w-px bg-border-light"></div>
          <div class="flex items-center gap-3 cursor-pointer" onclick="window.location.href='mypage.html'">
            <div class="text-right hidden sm:block">
              <p id="header-user-name" class="text-sm font-medium text-text-main dark:text-white leading-none">불러오는 중...</p>
              <p id="header-user-role" class="text-xs text-text-muted mt-1">로그인 필요</p>
            </div>
            <div id="header-avatar" class="h-9 w-9 rounded-full bg-primary flex items-center justify-center text-white font-bold">U</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="md:flex md:items-center md:justify-between mb-8">
      <div class="min-w-0 flex-1">
        <h1 class="text-2xl font-bold sm:text-3xl">이벤트 대시보드</h1>
        <p class="mt-2 text-sm text-text-muted">진행 중인 이벤트와 종료 이벤트를 확인하세요.</p>
      </div>
      <div class="mt-4 md:mt-0">
        <button class="inline-flex items-center gap-2 rounded-md bg-primary px-4 py-2.5 text-sm font-semibold text-white hover:bg-primary-hover transition-colors" type="button" onclick="window.location.href='event-creation-modal.html'">
          <span class="material-symbols-outlined text-sm">add</span>
          새 이벤트 등록
        </button>
      </div>
    </div>

    <div class="bg-surface-light rounded-lg border border-border-light p-1 mb-8 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
      <div class="flex w-full md:w-auto p-1 bg-background-light rounded-md">
        <button id="btn-filter-all" data-filter="all" class="flex-1 md:flex-none px-4 py-1.5 text-sm font-medium rounded text-text-main bg-white shadow-sm transition-all">전체</button>
        <button id="btn-filter-active" data-filter="active" class="flex-1 md:flex-none px-4 py-1.5 text-sm font-medium rounded text-text-muted hover:text-text-main transition-all">진행중</button>
        <button id="btn-filter-closed" data-filter="closed" class="flex-1 md:flex-none px-4 py-1.5 text-sm font-medium rounded text-text-muted hover:text-text-main transition-all">종료됨</button>
      </div>
      <div class="flex w-full md:w-auto gap-3 px-2 pb-2 md:pb-0">
        <div class="relative flex-grow md:w-72">
          <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
            <span class="material-symbols-outlined text-text-muted text-[18px]">search</span>
          </div>
          <input id="event-search-input" class="block w-full rounded-md border-0 py-1.5 pl-10 pr-3 text-text-main shadow-sm ring-1 ring-inset ring-border-light placeholder:text-text-muted focus:ring-2 focus:ring-inset focus:ring-primary sm:text-sm" placeholder="이벤트명 또는 키워드 검색" type="text" />
        </div>
      </div>
    </div>

    <div id="event-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </main>

  <script src="js/main.js"></script>
  <script>
    let dashboardEvents = [];
    let currentFilter = 'all';
    let currentKeyword = '';

    function escapeHtml(value) {
      return String(value || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function stripHtml(value) {
      return String(value || '').replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
    }

    function extractFirstImageSrc(value) {
      const match = String(value || '').match(/<img[^>]+src=["']([^"']+)["']/i);
      return match ? match[1] : '';
    }

    function toEffectiveStatus(event) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const endDate = event.end_date ? new Date(event.end_date) : null;
      if (endDate) endDate.setHours(0, 0, 0, 0);
      if (event.status === 'closed') return 'closed';
      if (endDate && endDate < today) return 'closed';
      return 'active';
    }

    function getBadge(status) {
      if (status === 'active') return '<span class="inline-flex items-center gap-1.5 rounded-full bg-emerald-50 px-2.5 py-0.5 text-xs font-medium text-emerald-700"><span class="h-1.5 w-1.5 rounded-full bg-emerald-600"></span>진행중</span>';
      return '<span class="inline-flex items-center gap-1.5 rounded-full bg-gray-100 px-2.5 py-0.5 text-xs font-medium text-gray-700"><span class="h-1.5 w-1.5 rounded-full bg-gray-500"></span>종료됨</span>';
    }

    function setFilterButtonState() {
      const mapping = {
        all: document.getElementById('btn-filter-all'),
        active: document.getElementById('btn-filter-active'),
        closed: document.getElementById('btn-filter-closed'),
      };
      Object.entries(mapping).forEach(([key, btn]) => {
        if (!btn) return;
        if (key === currentFilter) {
          btn.className = 'flex-1 md:flex-none px-4 py-1.5 text-sm font-medium rounded text-text-main bg-white shadow-sm transition-all';
        } else {
          btn.className = 'flex-1 md:flex-none px-4 py-1.5 text-sm font-medium rounded text-text-muted hover:text-text-main transition-all';
        }
      });
    }

    function renderEvents() {
      const list = document.getElementById('event-list');
      if (!list) return;

      const filtered = dashboardEvents.filter((event) => {
        const status = event.effective_status || toEffectiveStatus(event);
        if (currentFilter !== 'all' && status !== currentFilter) return false;
        if (!currentKeyword) return true;
        const haystack = `${event.title || ''} ${event.description || ''}`.toLowerCase();
        return haystack.includes(currentKeyword);
      });

      const createCard = `
        <article class="bg-surface-light rounded-lg border border-dashed border-border-light shadow-sm hover:border-primary hover:bg-primary-light/10 transition-all duration-200 group flex flex-col h-full items-center justify-center p-6 min-h-[250px] cursor-pointer" onclick="window.location.href='event-creation-modal.html'">
          <div class="w-12 h-12 rounded-full bg-background-light flex items-center justify-center mb-4 group-hover:bg-white group-hover:text-primary transition-colors">
            <span class="material-symbols-outlined text-text-muted group-hover:text-primary text-2xl">add</span>
          </div>
          <h3 class="text-base font-medium text-text-main">새 이벤트 생성</h3>
          <p class="text-xs text-text-muted mt-2 text-center">새 TWF 이벤트를 시작합니다.</p>
        </article>`;

      if (!filtered.length) {
        list.innerHTML = `<div class="col-span-full p-10 text-center text-text-muted bg-white rounded-lg border border-dashed border-border-light">조건에 맞는 이벤트가 없습니다.</div>${createCard}`;
        return;
      }

      const cards = filtered.map((event) => {
        const status = event.effective_status || toEffectiveStatus(event);
        const descriptionText = stripHtml(event.description || '');
        const firstImageSrc = extractFirstImageSrc(event.description || '');
        return `
        <article class="bg-surface-light rounded-lg border border-border-light shadow-sm hover:shadow-md hover:border-primary/50 transition-all duration-200 group flex flex-col h-full" onclick="navigateToEvent('${event.id}')">
          <div class="p-6 flex-1">
            <div class="mb-4">${getBadge(status)}</div>
            <h3 class="text-lg font-semibold text-text-main mb-2 leading-tight">${escapeHtml(event.title || '-')}</h3>
            ${firstImageSrc ? `
              <div class="mb-4 h-28 w-full overflow-hidden rounded border border-border-light bg-gray-50">
                <img src="${escapeHtml(firstImageSrc)}" alt="이벤트 미리보기" class="h-full w-full object-cover" loading="lazy" />
              </div>
            ` : ''}
            <p class="text-sm text-text-muted mb-4 line-clamp-2">${escapeHtml(descriptionText || '설명이 없습니다.')}</p>
            <div class="flex items-center gap-2 text-xs text-text-muted font-mono bg-background-light px-3 py-2 rounded border border-border-light mb-4">
              <span class="material-symbols-outlined text-[14px]">calendar_today</span>
              <span>${formatDate(event.start_date)}</span>
              <span class="text-gray-300">|</span>
              <span>${formatDate(event.end_date)}</span>
            </div>
          </div>
          <div class="border-t border-border-light px-6 py-4 bg-gray-50/50 rounded-b-lg">
            <div class="flex justify-end items-center text-sm font-semibold text-primary">상세 보기</div>
          </div>
        </article>`;
      }).join('');

      list.innerHTML = cards + createCard;
    }

    async function initDashboard() {
      if (typeof window.fetchEvents !== 'function') {
        setTimeout(initDashboard, 100);
        return;
      }

      const events = await window.fetchEvents('all');
      dashboardEvents = (events || []).map((event) => ({ ...event, effective_status: event.effective_status || toEffectiveStatus(event) }));

      document.querySelectorAll('[data-filter]')?.forEach((btn) => {
        btn.addEventListener('click', () => {
          currentFilter = btn.dataset.filter || 'all';
          setFilterButtonState();
          renderEvents();
        });
      });
      document.getElementById('event-search-input')?.addEventListener('input', (e) => {
        currentKeyword = (e.target.value || '').trim().toLowerCase();
        renderEvents();
      });

      setFilterButtonState();
      renderEvents();
      if (window.setupUI) await window.setupUI();
    }

    document.addEventListener('DOMContentLoaded', initDashboard);
  </script>
</body>
</html>
