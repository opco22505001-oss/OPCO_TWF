<!-- 이벤트 생성 모달 -->
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>이벤트 생성 모달 - OPE 플랫폼</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ecd6",
                        "primary-hover": "#0ddbc7",
                        "primary-text": "#102220",
                        "background-light": "#f6f8f8",
                        "background-dark": "#102220",
                        "surface-light": "#ffffff",
                        "border-light": "#e2e8f0",
                        "text-main": "#0f172a",
                        "text-muted": "#64748b",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "mono": ["JetBrains Mono", "monospace"],
                    },
                    borderRadius: { "DEFAULT": "0.375rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                    boxShadow: {
                        "modal": "0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1)",
                    }
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-text-main h-screen w-full overflow-hidden flex items-center justify-center relative">
    <div aria-hidden="true" class="absolute inset-0 z-0 overflow-hidden pointer-events-none select-none">
        <div
            class="h-16 border-b border-border-light bg-surface-light flex items-center px-8 justify-between opacity-40 filter blur-[2px]">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 rounded bg-primary/20"></div>
                <div class="h-4 w-32 bg-gray-200 rounded"></div>
            </div>
            <div class="flex gap-4">
                <div class="h-8 w-8 rounded-full bg-gray-200"></div>
            </div>
        </div>
        <div class="p-8 grid grid-cols-3 gap-6 opacity-40 filter blur-[2px]">
            <div class="h-64 rounded-xl border border-border-light bg-white p-6 flex flex-col gap-4">
                <div class="h-6 w-1/2 bg-gray-100 rounded"></div>
                <div class="h-4 w-full bg-gray-100 rounded"></div>
            </div>
            <div class="h-64 rounded-xl border border-border-light bg-white p-6 flex flex-col gap-4">
                <div class="h-6 w-1/2 bg-gray-100 rounded"></div>
                <div class="h-4 w-full bg-gray-100 rounded"></div>
            </div>
            <div class="h-64 rounded-xl border border-border-light bg-white p-6 flex flex-col gap-4">
                <div class="h-6 w-1/2 bg-gray-100 rounded"></div>
                <div class="h-4 w-full bg-gray-100 rounded"></div>
            </div>
        </div>
        <div class="absolute inset-0 bg-background-dark/20 backdrop-blur-sm z-10"></div>
    </div>
    <div
        class="relative z-20 w-full max-w-[640px] bg-surface-light rounded-xl shadow-modal border border-border-light flex flex-col max-h-[90vh] animate-in fade-in zoom-in-95 duration-200">
        <div class="flex items-center justify-between px-8 py-6 border-b border-border-light bg-white rounded-t-xl">
            <div>
                <h2 id="modal-title" class="text-xl font-semibold tracking-tight text-text-main">새 이벤트 생성</h2>
                <p id="modal-desc" class="text-sm text-text-muted mt-1">챌린지 설정 및 제약 조건을 구성합니다.</p>
            </div>
            <button class="text-text-muted hover:text-text-main transition-colors p-2 rounded hover:bg-gray-100">
                <span class="material-symbols-outlined text-[20px]">close</span>
            </button>
        </div>
        <div class="px-8 py-4 bg-background-light border-b border-border-light flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div
                    class="flex items-center justify-center w-6 h-6 rounded-full bg-primary text-primary-text text-xs font-bold font-mono">
                    1</div>
                <span class="text-sm font-medium text-text-main">기본 정보</span>
            </div>
            <div class="h-[1px] w-12 bg-gray-300"></div>
            <div class="flex items-center gap-2 opacity-50">
                <div
                    class="flex items-center justify-center w-6 h-6 rounded-full border border-gray-400 text-gray-500 text-xs font-bold font-mono">
                    2</div>
                <span class="text-sm font-medium text-text-muted">일정 설정</span>
            </div>
            <div class="h-[1px] w-12 bg-gray-300"></div>
            <div class="flex items-center gap-2 opacity-50">
                <div
                    class="flex items-center justify-center w-6 h-6 rounded-full border border-gray-400 text-gray-500 text-xs font-bold font-mono">
                    3</div>
                <span class="text-sm font-medium text-text-muted">가이드라인</span>
            </div>
        </div>
        <div class="p-8 overflow-y-auto custom-scrollbar flex flex-col gap-6">
            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-text-main" for="event-title">이벤트 제목</label>
                <input
                    class="w-full rounded border-border-light bg-white px-4 py-2.5 text-text-main placeholder:text-text-muted/60 focus:border-primary focus:ring-1 focus:ring-primary transition-all font-display shadow-sm"
                    id="event-title" placeholder="예: Q3 공정 효율 개선 챌린지" type="text" />
            </div>
            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-text-main" for="event-desc">상세 설명 및 목표</label>
                <textarea
                    class="w-full rounded border-border-light bg-white px-4 py-3 text-text-main placeholder:text-text-muted/60 focus:border-primary focus:ring-1 focus:ring-primary transition-all font-display shadow-sm resize-none"
                    id="event-desc" placeholder="이 이벤트의 목적과 목표를 간략하게 기술하세요..." rows="4"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-text-main" for="start-date">시작일</label>
                    <div class="relative">
                        <input
                            class="w-full rounded border-border-light bg-white pl-10 pr-4 py-2.5 text-text-main font-mono text-sm focus:border-primary focus:ring-1 focus:ring-primary cursor-pointer hover:bg-gray-50 transition-all shadow-sm"
                            id="start-date" type="date" value="2026-02-23" />
                        <span
                            class="material-symbols-outlined absolute left-3 top-2.5 text-text-muted text-[18px]">calendar_today</span>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-text-main" for="end-date">종료일</label>
                    <div class="relative">
                        <input
                            class="w-full rounded border-border-light bg-white pl-10 pr-4 py-2.5 text-text-main font-mono text-sm focus:border-primary focus:ring-1 focus:ring-primary cursor-pointer hover:bg-gray-50 transition-all shadow-sm"
                            id="end-date" type="date" value="2026-03-31" />
                        <span
                            class="material-symbols-outlined absolute left-3 top-2.5 text-text-muted text-[18px]">event</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-text-main" for="guide-file">이벤트 기획안내 파일 (참가자 열람용)</label>
                <div class="relative">
                    <input
                        class="w-full rounded border-border-light bg-white px-4 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary file:mr-4 file:py-1 file:px-4 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20"
                        id="guide-file" type="file" multiple />
                    <p class="text-[10px] text-text-muted mt-1">* 이벤트 상세 페이지에서 참가자들이 다운로드할 수 있는 가이드 파일입니다. (다중 선택 가능)
                    </p>
                </div>
            </div>

            <hr class="border-border-light my-1" />
            <div
                class="flex items-center justify-between p-4 rounded-lg border border-border-light bg-background-light/50">
                <div class="flex flex-col gap-1">
                    <span class="text-sm font-medium text-text-main">파일 업로드 허용</span>
                    <span class="text-xs text-text-muted">참가자가 PDF, PNG, CAD 파일 등을 첨부할 수 있습니다.</span>
                </div>
                <input type="checkbox" id="allow-file" class="hidden" checked>
                <button id="toggle-allow-file" aria-checked="true"
                    class="group relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-primary transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                    role="switch" type="button"
                    onclick="this.ariaChecked = this.ariaChecked === 'true' ? 'false' : 'true'; this.classList.toggle('bg-primary'); this.classList.toggle('bg-gray-200'); this.querySelector('span').classList.toggle('translate-x-5'); this.querySelector('span').classList.toggle('translate-x-0'); document.getElementById('allow-file').checked = this.ariaChecked === 'true';">
                    <span class="sr-only">설정 사용</span>
                    <span aria-hidden="true"
                        class="pointer-events-none inline-block h-5 w-5 translate-x-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                </button>
            </div>
            <div
                class="flex items-center justify-between p-4 rounded-lg border border-border-light bg-background-light/50">
                <div class="flex flex-col gap-1">
                    <span class="text-sm font-medium text-text-main">블라인드 심사</span>
                    <span class="text-xs text-text-muted">심사 위원에게 제안자의 익명성을 보장합니다.</span>
                </div>
                <input type="checkbox" id="is-blind" class="hidden">
                <button id="toggle-is-blind" aria-checked="false"
                    class="group relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gray-200 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                    role="switch" type="button"
                    onclick="this.ariaChecked = this.ariaChecked === 'true' ? 'false' : 'true'; this.classList.toggle('bg-primary'); this.classList.toggle('bg-gray-200'); this.querySelector('span').classList.toggle('translate-x-5'); this.querySelector('span').classList.toggle('translate-x-0'); document.getElementById('is-blind').checked = this.ariaChecked === 'true';">
                    <span class="sr-only">설정 사용</span>
                    <span aria-hidden="true"
                        class="pointer-events-none inline-block h-5 w-5 translate-x-0 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                </button>
            </div>

            <!-- 심사 기준 설정 섹션 -->
            <div class="flex flex-col gap-3 p-4 rounded-lg border border-border-light bg-background-light/50">
                <div class="flex items-center justify-between">
                    <div class="flex flex-col gap-1">
                        <span class="text-sm font-medium text-text-main">심사 기준 설정</span>
                        <span class="text-xs text-text-muted">심사자가 제출물을 평가할 기준을 추가하세요. (각 기준별 1~10점)</span>
                    </div>
                    <button type="button" id="btn-add-criteria"
                        class="flex items-center gap-1 text-xs font-medium text-primary hover:text-primary-hover bg-primary/10 hover:bg-primary/20 px-3 py-1.5 rounded-full transition-colors">
                        <span class="material-symbols-outlined text-[14px]">add</span> 기준 추가
                    </button>
                </div>
                <div id="criteria-list" class="space-y-2 mt-1">
                    <!-- 기본 기준 -->
                    <div class="criteria-item flex items-center gap-2">
                        <input type="text"
                            class="criteria-name flex-1 rounded border-border-light bg-white px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary"
                            value="혁신성" placeholder="기준명">
                        <button type="button"
                            class="btn-remove-criteria text-gray-400 hover:text-red-500 transition-colors" title="삭제">
                            <span class="material-symbols-outlined text-[18px]">close</span>
                        </button>
                    </div>
                    <div class="criteria-item flex items-center gap-2">
                        <input type="text"
                            class="criteria-name flex-1 rounded border-border-light bg-white px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary"
                            value="실현 가능성" placeholder="기준명">
                        <button type="button"
                            class="btn-remove-criteria text-gray-400 hover:text-red-500 transition-colors" title="삭제">
                            <span class="material-symbols-outlined text-[18px]">close</span>
                        </button>
                    </div>
                    <div class="criteria-item flex items-center gap-2">
                        <input type="text"
                            class="criteria-name flex-1 rounded border-border-light bg-white px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary"
                            value="효과성" placeholder="기준명">
                        <button type="button"
                            class="btn-remove-criteria text-gray-400 hover:text-red-500 transition-colors" title="삭제">
                            <span class="material-symbols-outlined text-[18px]">close</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 심사자 배정 섹션 -->
            <div class="flex flex-col gap-3 p-4 rounded-lg border border-border-light bg-background-light/50">
                <div class="flex items-center justify-between">
                    <div class="flex flex-col gap-1">
                        <span class="text-sm font-medium text-text-main">심사자 배정</span>
                        <span class="text-xs text-text-muted">이 이벤트의 심사를 담당할 직원을 선택하세요.</span>
                    </div>
                    <span id="judge-count"
                        class="text-xs font-medium text-primary bg-primary/10 px-2 py-1 rounded-full">0명 선택</span>
                </div>
                <input type="text" id="judge-search"
                    class="rounded border-border-light bg-white px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary"
                    placeholder="이름 또는 부서로 검색...">
                <div id="judges-list" class="max-h-48 overflow-y-auto space-y-1 mt-1">
                    <div class="animate-pulse h-8 bg-gray-200 rounded"></div>
                </div>
            </div>
        </div>
        <div
            class="flex items-center justify-between px-8 py-5 border-t border-border-light bg-gray-50/50 rounded-b-xl">
            <a class="text-text-muted hover:text-primary dark:hover:text-primary-light px-3 py-2 rounded-md text-sm font-medium transition-colors"
                href="mypage.html">제안 현황</a>
            <div class="flex gap-3">
                <button id="btn-save-draft"
                    class="px-5 py-2.5 rounded text-sm font-medium text-text-main border border-border-light bg-white hover:bg-gray-50 hover:border-gray-300 transition-all shadow-sm">
                    초안 저장
                </button>
                <button id="btn-continue"
                    class="px-5 py-2.5 rounded text-sm font-bold text-primary-text bg-primary hover:bg-primary-hover shadow-sm transition-all flex items-center gap-2">
                    <span id="btn-continue-text">이벤트 등록 및 대시보드 이동</span>
                    <span class="material-symbols-outlined text-[16px] font-bold">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const eventId = getQueryParam('id');
            const isEditMode = !!eventId;

            const btnSaveDraft = document.getElementById('btn-save-draft');
            const btnContinue = document.getElementById('btn-continue');
            const btnContinueText = document.getElementById('btn-continue-text');
            const judgesList = document.getElementById('judges-list');
            const judgeCountEl = document.getElementById('judge-count');
            const judgeSearch = document.getElementById('judge-search');
            const criteriaList = document.getElementById('criteria-list');
            const btnAddCriteria = document.getElementById('btn-add-criteria');

            // 수정 모드일 때 UI 변경
            if (isEditMode) {
                document.getElementById('modal-title').textContent = '이벤트 수정';
                document.getElementById('modal-desc').textContent = '기존 이벤트의 정보를 수정합니다.';
                btnContinueText.textContent = '이벤트 수정 완료';
                if (btnSaveDraft) btnSaveDraft.style.display = 'none'; // 수정 모드에선 초안 저장 숨김
            }

            // ========== 심사 기준 동적 관리 ==========
            function addCriteriaItem(name = '') {
                const item = document.createElement('div');
                item.className = 'criteria-item flex items-center gap-2';
                item.innerHTML = `
                    <input type="text" class="criteria-name flex-1 rounded border-border-light bg-white px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary" value="${name}" placeholder="기준명 입력">
                    <button type="button" class="btn-remove-criteria text-gray-400 hover:text-red-500 transition-colors" title="삭제">
                        <span class="material-symbols-outlined text-[18px]">close</span>
                    </button>
                `;
                criteriaList.appendChild(item);
            }

            if (btnAddCriteria) {
                btnAddCriteria.addEventListener('click', () => addCriteriaItem());
            }

            // 삭제 버튼 위임
            if (criteriaList) {
                criteriaList.addEventListener('click', (e) => {
                    const rmBtn = e.target.closest('.btn-remove-criteria');
                    if (rmBtn) rmBtn.closest('.criteria-item').remove();
                });
            }

            function collectCriteria() {
                if (!criteriaList) return [];
                return Array.from(criteriaList.querySelectorAll('.criteria-name'))
                    .map(inp => inp.value.trim())
                    .filter(v => v.length > 0)
                    .map(name => ({ name, max_score: 10 }));
            }

            // ========== 심사자 후보 목록 (corporate_employees 125명) ==========
            let allEmployees = [];
            let existingJudges = [];
            try {
                if (typeof window.fetchCorporateEmployees === 'function') {
                    allEmployees = await window.fetchCorporateEmployees();
                }
                if (isEditMode) {
                    existingJudges = await window.fetchEventJudges(eventId);
                }
            } catch (e) {
                console.error('[EventCreate] 초기 데이터 로드 실패:', e);
            }

            function renderJudges(filter = '') {
                if (!judgesList || allEmployees.length === 0) {
                    if (judgesList) judgesList.innerHTML = '<p class="text-xs text-text-muted text-center py-2">등록된 임직원이 없습니다.</p>';
                    return;
                }
                const keyword = filter.toLowerCase();
                const filtered = keyword
                    ? allEmployees.filter(e => (e.empnm || '').toLowerCase().includes(keyword) || (e.depnm || '').toLowerCase().includes(keyword))
                    : allEmployees;

                // 기존 체크 상태 보존 (수정 모드일 때 초기값 포함)
                const currentChecked = Array.from(judgesList.querySelectorAll('.judge-checkbox:checked')).map(cb => cb.value);
                const existingChecked = existingJudges.map(j => {
                    // email에서 사번 추출
                    const { data: userData } = j; // j는 event_judges 행
                    // 실제로는 fetchEventJudges가 users 정보를 조인해서 가져오므로 structure 확인 필요
                    return j.users?.email?.split('@')[0];
                }).filter(Boolean);

                const checkedSet = new Set([...currentChecked, ...existingChecked]);

                judgesList.innerHTML = filtered.map(e => `
                    <label class="flex items-center gap-3 p-1.5 rounded hover:bg-white cursor-pointer transition-colors">
                        <input type="checkbox" class="judge-checkbox rounded border-gray-300 text-primary focus:ring-primary" value="${e.empno}" data-name="${e.empnm || ''}" ${checkedSet.has(e.empno) ? 'checked' : ''}>
                        <div class="flex-1 min-w-0">
                            <span class="text-sm font-medium text-text-main">${e.empnm || '이름없음'}</span>
                            <span class="text-xs text-text-muted ml-2">${e.depnm || ''}</span>
                        </div>
                        <span class="text-xs px-2 py-0.5 rounded-full ${e.role === 'admin' ? 'bg-blue-50 text-blue-700' : 'bg-gray-100 text-gray-600'}">${e.role === 'admin' ? '관리자' : '직원'}</span>
                    </label>
                `).join('');

                updateJudgeCount();
            }

            function updateJudgeCount() {
                if (!judgesList || !judgeCountEl) return;
                const checked = judgesList.querySelectorAll('.judge-checkbox:checked').length;
                judgeCountEl.textContent = `${checked}명 선택`;
            }

            renderJudges();

            if (judgesList) judgesList.addEventListener('change', updateJudgeCount);
            if (judgeSearch) {
                judgeSearch.addEventListener('input', () => renderJudges(judgeSearch.value));
            }

            // 선택된 심사자 사번 배열
            function getSelectedJudgeEmpnos() {
                if (!judgesList) return [];
                return Array.from(judgesList.querySelectorAll('.judge-checkbox:checked')).map(cb => ({
                    empno: cb.value,
                    name: cb.dataset.name || ''
                }));
            }

            // ========== 이벤트 생성 후 심사자 배정 + 알림 ==========
            async function assignAndNotifyJudges(eventId, eventTitle) {
                const selected = getSelectedJudgeEmpnos();
                if (selected.length === 0) return;

                // 1) 전체 사용자 목록(public.users) 가져오기
                let allUsers = [];
                try {
                    const { data, error } = await supabaseClient.from('users').select('id, email, name');
                    if (!error) allUsers = data;
                } catch (e) { console.error(e); }

                const userMap = {};
                allUsers.forEach(u => {
                    // 이메일에서 사번 추출 (예: 22505001@opco.internal -> 22505001)
                    if (u.email) {
                        const empno = u.email.split('@')[0];
                        userMap[empno] = u.id;
                    }
                });

                let successCount = 0;
                let failCount = 0;

                for (const judge of selected) {
                    let userId = userMap[judge.empno];

                    if (!userId) {
                        console.warn(`[EventCreate] 사번 ${judge.empno} (${judge.name})은 아직 가입하지 않았거나 찾을 수 없습니다.`);
                        failCount++;
                        continue;
                    }

                    try {
                        await window.assignJudge(eventId, userId);
                        if (typeof window.createNotification === 'function') {
                            await window.createNotification(
                                userId,
                                `[심사 배정] "${eventTitle}" 이벤트의 심사자로 배정되었습니다.`,
                                `event-detail.html?id=${eventId}`
                            );
                        }
                        successCount++;
                    } catch (e) {
                        console.error(`[EventCreate] 심사자 배정 실패 (${judge.name}):`, e);
                        failCount++;
                    }
                }

                if (failCount > 0) {
                    const failedNames = selected.filter(j => !userMap[j.empno]).map(j => j.name).join(', ');
                    console.log(`[EventCreate] 배정 완료: 성공 ${successCount}명, 실패 ${failCount}명 (미가입자: ${failedNames})`);
                    if (failedNames) {
                        alert(`일부 심사자(${failedNames})는 아직 시스템에 가입(로그인)하지 않아 배정되지 않았습니다.\n해당 인원이 로그인한 후 관리자 메뉴에서 다시 배정해 주세요.`);
                    }
                }
            }

            // ========== 공통 데이터 수집 ==========
            async function collectEventData(status) {
                const buildStoredName = (file) => {
                    const normalized = (file?.name || 'file').normalize('NFC');
                    const extIndex = normalized.lastIndexOf('.');
                    const ext = extIndex > -1 ? normalized.slice(extIndex) : '';
                    const token = (crypto?.randomUUID?.() || `${Date.now()}_${Math.random().toString(36).slice(2, 8)}`).replace(/[^a-zA-Z0-9_-]/g, '');
                    return `${Date.now()}_${token}${ext}`;
                };
                const withOriginalName = (publicUrl, originalName) => {
                    const normalized = (originalName || '').normalize('NFC');
                    return `${publicUrl}#name=${encodeURIComponent(normalized)}`;
                };
                const MAX_UPLOAD_BYTES = 50 * 1024 * 1024;
                const ALLOWED_UPLOAD_EXTS = ['pdf', 'png', 'jpg', 'jpeg', 'gif', 'webp', 'txt', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'zip', 'hwp', 'hwpx', 'dwg', 'dxf'];
                const validateUploadFile = (file) => {
                    const ext = (file.name.split('.').pop() || '').toLowerCase();
                    if (!ALLOWED_UPLOAD_EXTS.includes(ext)) {
                        return `허용되지 않는 파일 형식입니다: ${file.name}`;
                    }
                    if (file.size > MAX_UPLOAD_BYTES) {
                        return `50MB를 초과한 파일입니다: ${file.name}`;
                    }
                    return null;
                };

                const data = {
                    title: document.getElementById('event-title').value,
                    description: document.getElementById('event-desc').value,
                    start_date: document.getElementById('start-date').value,
                    end_date: document.getElementById('end-date').value,
                    allow_file_upload: document.getElementById('allow-file').checked,
                    is_blind_judging: document.getElementById('is-blind').checked,
                    pass_criteria: collectCriteria(),
                    status: status,
                    attachments: []
                };

                // 기획안내 파일 업로드 처리
                const guideFileInput = document.getElementById('guide-file');
                if (guideFileInput && guideFileInput.files.length > 0) {
                    const files = Array.from(guideFileInput.files);
                    const uploadedUrls = [];

                    for (const file of files) {
                        const invalid = validateUploadFile(file);
                        if (invalid) {
                            alert(invalid);
                            continue;
                        }
                        const fileName = buildStoredName(file);
                        const filePath = `event-guides/${fileName}`;

                        try {
                            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                                .from('event-attachments') // 'event-attachments' 버킷 사용
                                .upload(filePath, file);

                            if (uploadError) throw uploadError;

                            const { data: { publicUrl } } = supabaseClient.storage
                                .from('event-attachments')
                                .getPublicUrl(filePath);

                            uploadedUrls.push(withOriginalName(publicUrl, file.name));
                        } catch (err) {
                            console.error(`[EventCreate] 파일 업로드 실패 (${file.name}):`, err);
                            if (!confirm(`'${file.name}' 파일 업로드에 실패했습니다. 이 파일을 제외하고 계속하시겠습니까?`)) {
                                throw new Error('파일 업로드 중단');
                            }
                        }
                    }
                    data.attachments = uploadedUrls;
                }

                return data;
            }

            // ========== 수정 모드 시 기존 데이터 채우기 ==========
            if (isEditMode) {
                try {
                    const event = await window.fetchEventDetails(eventId);
                    if (event) {
                        document.getElementById('event-title').value = event.title || '';
                        document.getElementById('event-desc').value = event.description || '';
                        document.getElementById('start-date').value = event.start_date || '';
                        document.getElementById('end-date').value = event.end_date || '';

                        // 설정값
                        const allowFile = document.getElementById('allow-file');
                        const isBlind = document.getElementById('is-blind');
                        const toggleAllowFile = document.getElementById('toggle-allow-file');
                        const toggleIsBlind = document.getElementById('toggle-is-blind');

                        if (event.allow_file_upload !== allowFile.checked) {
                            toggleAllowFile.click();
                        }
                        if (event.is_blind_judging !== isBlind.checked) {
                            toggleIsBlind.click();
                        }

                        // 심사 기준
                        if (event.pass_criteria && event.pass_criteria.length > 0) {
                            criteriaList.innerHTML = '';
                            event.pass_criteria.forEach(c => addCriteriaItem(c.name));
                        }
                    }
                } catch (err) {
                    console.error('[EventEdit] 기존 데이터 로드 오류:', err);
                }
            }

            // ========== 이벤트 등록 공통 함수 ==========
            async function submitEvent(status, btn, originalText) {
                if (!document.getElementById('event-title').value) { alert('이벤트 제목을 입력해주세요.'); return; }

                btn.textContent = status === 'draft' ? '저장 중...' : (isEditMode ? '수정 중...' : '등록 중...');
                btn.disabled = true;

                try {
                    const data = await collectEventData(status);

                    if (typeof window.createEvent !== 'function' || typeof window.updateEvent !== 'function') {
                        throw new Error('시스템 초기화 중입니다. 잠시 후 다시 시도해 주세요.');
                    }

                    let result;
                    if (isEditMode) {
                        result = await window.updateEvent(eventId, data);
                    } else {
                        result = await window.createEvent(data);
                    }

                    if (result.error) {
                        alert((isEditMode ? '수정' : (status === 'draft' ? '저장' : '등록')) + ' 실패: ' + (result.error.message || result.error));
                        btn.textContent = originalText;
                        btn.disabled = false;
                    } else {
                        const targetId = isEditMode ? eventId : (result.data ? result.data.id : null);
                        if (targetId) {
                            if (isEditMode) {
                                // 기존 심사자 초기화 후 다시 배정
                                await window.clearEventJudges(targetId);
                            }
                            await assignAndNotifyJudges(targetId, data.title);
                        }
                        alert(isEditMode ? '이벤트가 성공적으로 수정되었습니다.' : (status === 'draft' ? '초안이 저장되었습니다.' : '이벤트가 성공적으로 생성되었습니다!'));
                        window.location.href = isEditMode ? `event-detail.html?id=${eventId}` : 'dashboard.html';
                    }
                } catch (err) {
                    if (err.message !== '파일 업로드 중단') {
                        console.error('[EventSubmit] Error:', err);
                        alert('이벤트 처리 중 오류: ' + err.message);
                    }
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            }

            if (btnSaveDraft) btnSaveDraft.addEventListener('click', () => submitEvent('draft', btnSaveDraft, '초안 저장'));
            if (btnContinue) btnContinue.addEventListener('click', () => submitEvent('active', btnContinue, '이벤트 등록 및 대시보드 이동'));

            // 닫기(X) 버튼
            const btnClose = document.querySelector('.text-text-muted.hover\\:text-text-main');
            if (btnClose) {
                btnClose.addEventListener('click', () => { window.location.href = 'dashboard.html'; });
            }
        });
    </script>
</body>

</html>
