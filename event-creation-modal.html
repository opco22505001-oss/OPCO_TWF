<!-- ?대깽???앹꽦 紐⑤떖 -->
<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>?대깽???앹꽦 紐⑤떖 - OPE ?뚮옯??/title>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap"
        rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ecd6",
                        "primary-hover": "#0ddbc7",
                        "primary-text": "#102220",
                        "background-light": "#f6f8f8",
                        "background-dark": "#102220",
                        "surface-light": "#ffffff",
                        "border-light": "#e2e8f0",
                        "text-main": "#0f172a",
                        "text-muted": "#64748b",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "mono": ["JetBrains Mono", "monospace"],
                    },
                    borderRadius: { "DEFAULT": "0.375rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                    boxShadow: {
                        "modal": "0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1)",
                    }
                },
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-text-main h-screen w-full overflow-hidden flex items-center justify-center relative">
    <div aria-hidden="true" class="absolute inset-0 z-0 overflow-hidden pointer-events-none select-none">
        <div
            class="h-16 border-b border-border-light bg-surface-light flex items-center px-8 justify-between opacity-40 filter blur-[2px]">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 rounded bg-primary/20"></div>
                <div class="h-4 w-32 bg-gray-200 rounded"></div>
            </div>
            <div class="flex gap-4">
                <div class="h-8 w-8 rounded-full bg-gray-200"></div>
            </div>
        </div>
        <div class="p-8 grid grid-cols-3 gap-6 opacity-40 filter blur-[2px]">
            <div class="h-64 rounded-xl border border-border-light bg-white p-6 flex flex-col gap-4">
                <div class="h-6 w-1/2 bg-gray-100 rounded"></div>
                <div class="h-4 w-full bg-gray-100 rounded"></div>
            </div>
            <div class="h-64 rounded-xl border border-border-light bg-white p-6 flex flex-col gap-4">
                <div class="h-6 w-1/2 bg-gray-100 rounded"></div>
                <div class="h-4 w-full bg-gray-100 rounded"></div>
            </div>
            <div class="h-64 rounded-xl border border-border-light bg-white p-6 flex flex-col gap-4">
                <div class="h-6 w-1/2 bg-gray-100 rounded"></div>
                <div class="h-4 w-full bg-gray-100 rounded"></div>
            </div>
        </div>
        <div class="absolute inset-0 bg-background-dark/20 backdrop-blur-sm z-10"></div>
    </div>
    <div
        class="relative z-20 w-full max-w-[640px] bg-surface-light rounded-xl shadow-modal border border-border-light flex flex-col max-h-[90vh] animate-in fade-in zoom-in-95 duration-200">
        <div class="flex items-center justify-between px-8 py-6 border-b border-border-light bg-white rounded-t-xl">
            <div>
                <h2 id="modal-title" class="text-xl font-semibold tracking-tight text-text-main">???대깽???앹꽦</h2>
                <p id="modal-desc" class="text-sm text-text-muted mt-1">梨뚮┛吏 ?ㅼ젙 諛??쒖빟 議곌굔??援ъ꽦?⑸땲??</p>
            </div>
            <button class="text-text-muted hover:text-text-main transition-colors p-2 rounded hover:bg-gray-100">
                <span class="material-symbols-outlined text-[20px]">close</span>
            </button>
        </div>
        <div class="px-8 py-4 bg-background-light border-b border-border-light flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div
                    class="flex items-center justify-center w-6 h-6 rounded-full bg-primary text-primary-text text-xs font-bold font-mono">
                    1</div>
                <span class="text-sm font-medium text-text-main">湲곕낯 ?뺣낫</span>
            </div>
            <div class="h-[1px] w-12 bg-gray-300"></div>
            <div class="flex items-center gap-2 opacity-50">
                <div
                    class="flex items-center justify-center w-6 h-6 rounded-full border border-gray-400 text-gray-500 text-xs font-bold font-mono">
                    2</div>
                <span class="text-sm font-medium text-text-muted">?쇱젙 ?ㅼ젙</span>
            </div>
            <div class="h-[1px] w-12 bg-gray-300"></div>
            <div class="flex items-center gap-2 opacity-50">
                <div
                    class="flex items-center justify-center w-6 h-6 rounded-full border border-gray-400 text-gray-500 text-xs font-bold font-mono">
                    3</div>
                <span class="text-sm font-medium text-text-muted">媛?대뱶?쇱씤</span>
            </div>
        </div>
        <div class="p-8 overflow-y-auto custom-scrollbar flex flex-col gap-6">
            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-text-main" for="event-title">?대깽???쒕ぉ</label>
                <input
                    class="w-full rounded border-border-light bg-white px-4 py-2.5 text-text-main placeholder:text-text-muted/60 focus:border-primary focus:ring-1 focus:ring-primary transition-all font-display shadow-sm"
                    id="event-title" placeholder="?? Q3 怨듭젙 ?⑥쑉 媛쒖꽑 梨뚮┛吏" type="text" />
            </div>
            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-text-main" for="event-desc">?곸꽭 ?ㅻ챸 諛?紐⑺몴</label>
                <textarea
                    class="w-full rounded border-border-light bg-white px-4 py-3 text-text-main placeholder:text-text-muted/60 focus:border-primary focus:ring-1 focus:ring-primary transition-all font-display shadow-sm resize-none"
                    id="event-desc" placeholder="???대깽?몄쓽 紐⑹쟻怨?紐⑺몴瑜?媛꾨왂?섍쾶 湲곗닠?섏꽭??.." rows="4"></textarea>
                <p class="text-[11px] text-text-muted">클립보드 이미지 붙여넣기(Ctrl+V)를 지원합니다.</p>
                <div class="flex items-center gap-2">
                    <button id="btn-insert-desc-image" type="button"
                        class="inline-flex items-center gap-1 rounded-md border border-border-light bg-white px-3 py-1.5 text-xs font-semibold text-text-main hover:bg-gray-50">
                        <span class="material-symbols-outlined text-[16px]">image</span>
                        설명에 이미지 삽입
                    </button>
                    <span class="text-[11px] text-text-muted">로컬 이미지를 본문에 바로 삽입합니다.</span>
                </div>
                <input id="desc-image-file" type="file" accept="image/*" class="hidden" />
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-text-main" for="start-date">?쒖옉??/label>
                    <div class="relative">
                        <input
                            class="w-full rounded border-border-light bg-white pl-10 pr-4 py-2.5 text-text-main font-mono text-sm focus:border-primary focus:ring-1 focus:ring-primary cursor-pointer hover:bg-gray-50 transition-all shadow-sm"
                            id="start-date" type="date" value="2026-02-23" />
                        <span
                            class="material-symbols-outlined absolute left-3 top-2.5 text-text-muted text-[18px]">calendar_today</span>
                    </div>
                </div>
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-text-main" for="end-date">醫낅즺??/label>
                    <div class="relative">
                        <input
                            class="w-full rounded border-border-light bg-white pl-10 pr-4 py-2.5 text-text-main font-mono text-sm focus:border-primary focus:ring-1 focus:ring-primary cursor-pointer hover:bg-gray-50 transition-all shadow-sm"
                            id="end-date" type="date" value="2026-03-31" />
                        <span
                            class="material-symbols-outlined absolute left-3 top-2.5 text-text-muted text-[18px]">event</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-2">
                <label class="text-sm font-medium text-text-main" for="guide-file">泥⑤??뚯씪 (李멸????대엺??</label>
                <div class="relative">
                    <input
                        class="w-full rounded border-border-light bg-white px-4 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary file:mr-4 file:py-1 file:px-4 file:rounded file:border-0 file:text-xs file:font-semibold file:bg-primary/10 file:text-primary hover:file:bg-primary/20"
                        id="guide-file" type="file" multiple />
                    <p class="text-[10px] text-text-muted mt-1">* ?대깽???곸꽭 ?섏씠吏?먯꽌 李멸??먮뱾???ㅼ슫濡쒕뱶?????덈뒗 泥⑤??뚯씪?낅땲?? (?ㅼ쨷 ?좏깮 媛??
                    </p>
                </div>
            </div>

            <hr class="border-border-light my-1" />
            <div
                class="flex items-center justify-between p-4 rounded-lg border border-border-light bg-background-light/50">
                <div class="flex flex-col gap-1">
                    <span class="text-sm font-medium text-text-main">?뚯씪 ?낅줈???덉슜</span>
                    <span class="text-xs text-text-muted">李멸??먭? PDF, PNG, CAD ?뚯씪 ?깆쓣 泥⑤??????덉뒿?덈떎.</span>
                </div>
                <input type="checkbox" id="allow-file" class="hidden" checked>
                <button id="toggle-allow-file" aria-checked="true"
                    class="group relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-primary transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                    role="switch" type="button"
                    onclick="this.ariaChecked = this.ariaChecked === 'true' ? 'false' : 'true'; this.classList.toggle('bg-primary'); this.classList.toggle('bg-gray-200'); this.querySelector('span').classList.toggle('translate-x-5'); this.querySelector('span').classList.toggle('translate-x-0'); document.getElementById('allow-file').checked = this.ariaChecked === 'true';">
                    <span class="sr-only">?ㅼ젙 ?ъ슜</span>
                    <span aria-hidden="true"
                        class="pointer-events-none inline-block h-5 w-5 translate-x-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                </button>
            </div>
            <div
                class="flex items-center justify-between p-4 rounded-lg border border-border-light bg-background-light/50">
                <div class="flex flex-col gap-1">
                    <span class="text-sm font-medium text-text-main">釉붾씪?몃뱶 ?ъ궗</span>
                    <span class="text-xs text-text-muted">?ъ궗 ?꾩썝?먭쾶 ?쒖븞?먯쓽 ?듬챸?깆쓣 蹂댁옣?⑸땲??</span>
                </div>
                <input type="checkbox" id="is-blind" class="hidden">
                <button id="toggle-is-blind" aria-checked="false"
                    class="group relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-gray-200 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                    role="switch" type="button"
                    onclick="this.ariaChecked = this.ariaChecked === 'true' ? 'false' : 'true'; this.classList.toggle('bg-primary'); this.classList.toggle('bg-gray-200'); this.querySelector('span').classList.toggle('translate-x-5'); this.querySelector('span').classList.toggle('translate-x-0'); document.getElementById('is-blind').checked = this.ariaChecked === 'true';">
                    <span class="sr-only">?ㅼ젙 ?ъ슜</span>
                    <span aria-hidden="true"
                        class="pointer-events-none inline-block h-5 w-5 translate-x-0 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"></span>
                </button>
            </div>

            <!-- ?ъ궗 湲곗? ?ㅼ젙 ?뱀뀡 -->
            <div class="flex flex-col gap-3 p-4 rounded-lg border border-border-light bg-background-light/50">
                <div class="flex items-center justify-between">
                    <div class="flex flex-col gap-1">
                        <span class="text-sm font-medium text-text-main">?ъ궗 湲곗? ?ㅼ젙</span>
                        <span class="text-xs text-text-muted">?ъ궗?먭? ?쒖텧臾쇱쓣 ?됯???湲곗???異붽??섏꽭?? (媛?湲곗?蹂?1~10??</span>
                    </div>
                    <button type="button" id="btn-add-criteria"
                        class="flex items-center gap-1 text-xs font-medium text-primary hover:text-primary-hover bg-primary/10 hover:bg-primary/20 px-3 py-1.5 rounded-full transition-colors">
                        <span class="material-symbols-outlined text-[14px]">add</span> 湲곗? 異붽?
                    </button>
                </div>
                <div id="criteria-list" class="space-y-2 mt-1">
                    <!-- 湲곕낯 湲곗? -->
                    <div class="criteria-item flex items-center gap-2">
                        <input type="text"
                            class="criteria-name flex-1 rounded border-border-light bg-white px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary"
                            value="?곸떊?? placeholder="湲곗?紐?>
                        <button type="button"
                            class="btn-remove-criteria text-gray-400 hover:text-red-500 transition-colors" title="??젣">
                            <span class="material-symbols-outlined text-[18px]">close</span>
                        </button>
                    </div>
                    <div class="criteria-item flex items-center gap-2">
                        <input type="text"
                            class="criteria-name flex-1 rounded border-border-light bg-white px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary"
                            value="?ㅽ쁽 媛?μ꽦" placeholder="湲곗?紐?>
                        <button type="button"
                            class="btn-remove-criteria text-gray-400 hover:text-red-500 transition-colors" title="??젣">
                            <span class="material-symbols-outlined text-[18px]">close</span>
                        </button>
                    </div>
                    <div class="criteria-item flex items-center gap-2">
                        <input type="text"
                            class="criteria-name flex-1 rounded border-border-light bg-white px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary"
                            value="?④낵?? placeholder="湲곗?紐?>
                        <button type="button"
                            class="btn-remove-criteria text-gray-400 hover:text-red-500 transition-colors" title="??젣">
                            <span class="material-symbols-outlined text-[18px]">close</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ?ъ궗??諛곗젙 ?뱀뀡 -->
            <div class="flex flex-col gap-3 p-4 rounded-lg border border-border-light bg-background-light/50">
                <div class="flex items-center justify-between">
                    <div class="flex flex-col gap-1">
                        <span class="text-sm font-medium text-text-main">?ъ궗??諛곗젙</span>
                        <span class="text-xs text-text-muted">???대깽?몄쓽 ?ъ궗瑜??대떦??吏곸썝???좏깮?섏꽭??</span>
                    </div>
                    <span id="judge-count"
                        class="text-xs font-medium text-primary bg-primary/10 px-2 py-1 rounded-full">0紐??좏깮</span>
                </div>
                <input type="text" id="judge-search"
                    class="rounded border-border-light bg-white px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary"
                    placeholder="?대쫫 ?먮뒗 遺?쒕줈 寃??..">
                <div id="judges-list" class="max-h-48 overflow-y-auto space-y-1 mt-1">
                    <div class="animate-pulse h-8 bg-gray-200 rounded"></div>
                </div>
            </div>
        </div>
        <div
            class="flex items-center justify-between px-8 py-5 border-t border-border-light bg-gray-50/50 rounded-b-xl">
            <a class="text-text-muted hover:text-primary dark:hover:text-primary-light px-3 py-2 rounded-md text-sm font-medium transition-colors"
                href="mypage.html">?쒖븞 ?꾪솴</a>
            <div class="flex gap-3">
                <button id="btn-save-draft"
                    class="px-5 py-2.5 rounded text-sm font-medium text-text-main border border-border-light bg-white hover:bg-gray-50 hover:border-gray-300 transition-all shadow-sm">
                    珥덉븞 ???
                </button>
                <button id="btn-continue"
                    class="px-5 py-2.5 rounded text-sm font-bold text-primary-text bg-primary hover:bg-primary-hover shadow-sm transition-all flex items-center gap-2">
                    <span id="btn-continue-text">?대깽???깅줉 諛???쒕낫???대룞</span>
                    <span class="material-symbols-outlined text-[16px] font-bold">arrow_forward</span>
                </button>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const eventId = getQueryParam('id');
            const isEditMode = !!eventId;
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');

            // 신규 이벤트 기본값: 시작일=오늘, 종료일=오늘+14일
            if (!isEditMode && startDateInput && endDateInput) {
                const today = new Date();
                const end = new Date(today);
                end.setDate(end.getDate() + 14);

                const fmt = (d) => d.toISOString().slice(0, 10);
                startDateInput.value = fmt(today);
                endDateInput.value = fmt(end);
            }

            const btnSaveDraft = document.getElementById('btn-save-draft');
            const btnContinue = document.getElementById('btn-continue');
            const btnContinueText = document.getElementById('btn-continue-text');
            const judgesList = document.getElementById('judges-list');
            const judgeCountEl = document.getElementById('judge-count');
            const judgeSearch = document.getElementById('judge-search');
            const criteriaList = document.getElementById('criteria-list');
            const btnAddCriteria = document.getElementById('btn-add-criteria');
            const eventDescInput = document.getElementById('event-desc');
            const btnInsertDescImage = document.getElementById('btn-insert-desc-image');
            const descImageFileInput = document.getElementById('desc-image-file');

            async function uploadInlineDescriptionImage(file) {
                if (!file.type.startsWith('image/')) {
                    throw new Error('이미지 파일만 삽입할 수 있습니다.');
                }
                if (file.size > 20 * 1024 * 1024) {
                    throw new Error('이미지 파일은 20MB 이하만 허용됩니다.');
                }

                const ext = (file.name.split('.').pop() || 'png').toLowerCase();
                const safeExt = ext.replace(/[^a-z0-9]/g, '') || 'png';
                const fileName = `desc_${Date.now()}_${Math.random().toString(36).slice(2, 8)}.${safeExt}`;
                const filePath = `event-descriptions/${fileName}`;

                const { error: uploadError } = await supabaseClient.storage
                    .from('event-attachments')
                    .upload(filePath, file, { upsert: false });
                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabaseClient.storage
                    .from('event-attachments')
                    .getPublicUrl(filePath);

                return publicUrl;
            }

            function insertDescriptionImageTag(url, alt = 'description-image') {
                if (!eventDescInput) return;
                const start = eventDescInput.selectionStart || 0;
                const end = eventDescInput.selectionEnd || 0;
                const imageTag = `\n<img src="${url}" alt="${alt}" style="max-width:100%;" />\n`;
                const prev = eventDescInput.value || '';
                eventDescInput.value = prev.slice(0, start) + imageTag + prev.slice(end);
                const cursor = start + imageTag.length;
                eventDescInput.focus();
                eventDescInput.setSelectionRange(cursor, cursor);
            }

            if (eventDescInput) {
                eventDescInput.addEventListener('paste', async (e) => {
                    const clipboard = e.clipboardData;
                    if (!clipboard?.items?.length) return;

                    const imageItem = Array.from(clipboard.items).find((item) => item.type.startsWith('image/'));
                    if (!imageItem) return;

                    const file = imageItem.getAsFile();
                    if (!file) return;

                    e.preventDefault();

                    try {
                        const url = await uploadInlineDescriptionImage(file);
                        insertDescriptionImageTag(url, 'pasted-image');
                    } catch (pasteErr) {
                        console.error('[EventCreate] 이미지 붙여넣기 업로드 실패:', pasteErr);
                        alert(pasteErr?.message || '이미지 붙여넣기 업로드에 실패했습니다.');
                    }
                });
            }

            if (btnInsertDescImage && descImageFileInput) {
                btnInsertDescImage.addEventListener('click', () => descImageFileInput.click());
                descImageFileInput.addEventListener('change', async () => {
                    const file = descImageFileInput.files?.[0];
                    if (!file) return;
                    try {
                        const url = await uploadInlineDescriptionImage(file);
                        insertDescriptionImageTag(url, file.name || 'description-image');
                    } catch (err) {
                        console.error('[EventCreate] 설명 이미지 삽입 실패:', err);
                        alert(err?.message || '설명 이미지 삽입에 실패했습니다.');
                    } finally {
                        descImageFileInput.value = '';
                    }
                });
            }

            // ?섏젙 紐⑤뱶????UI 蹂寃?
            if (isEditMode) {
                document.getElementById('modal-title').textContent = '?대깽???섏젙';
                document.getElementById('modal-desc').textContent = '湲곗〈 ?대깽?몄쓽 ?뺣낫瑜??섏젙?⑸땲??';
                btnContinueText.textContent = '?대깽???섏젙 ?꾨즺';
                if (btnSaveDraft) btnSaveDraft.style.display = 'none'; // ?섏젙 紐⑤뱶?먯꽑 珥덉븞 ????④?
            }

            // ========== ?ъ궗 湲곗? ?숈쟻 愿由?==========
            function addCriteriaItem(name = '') {
                const item = document.createElement('div');
                item.className = 'criteria-item flex items-center gap-2';
                item.innerHTML = `
                    <input type="text" class="criteria-name flex-1 rounded border-border-light bg-white px-3 py-2 text-sm focus:border-primary focus:ring-1 focus:ring-primary" value="${name}" placeholder="湲곗?紐??낅젰">
                    <button type="button" class="btn-remove-criteria text-gray-400 hover:text-red-500 transition-colors" title="??젣">
                        <span class="material-symbols-outlined text-[18px]">close</span>
                    </button>
                `;
                criteriaList.appendChild(item);
            }

            if (btnAddCriteria) {
                btnAddCriteria.addEventListener('click', () => addCriteriaItem());
            }

            // ??젣 踰꾪듉 ?꾩엫
            if (criteriaList) {
                criteriaList.addEventListener('click', (e) => {
                    const rmBtn = e.target.closest('.btn-remove-criteria');
                    if (rmBtn) rmBtn.closest('.criteria-item').remove();
                });
            }

            function collectCriteria() {
                if (!criteriaList) return [];
                return Array.from(criteriaList.querySelectorAll('.criteria-name'))
                    .map(inp => inp.value.trim())
                    .filter(v => v.length > 0)
                    .map(name => ({ name, max_score: 10 }));
            }

            // ========== ?ъ궗???꾨낫 紐⑸줉 (corporate_employees 125紐? ==========
            let allEmployees = [];
            let existingJudges = [];
            try {
                if (typeof window.fetchCorporateEmployees === 'function') {
                    allEmployees = await window.fetchCorporateEmployees();
                }
                if (isEditMode) {
                    existingJudges = await window.fetchEventJudges(eventId);
                }
            } catch (e) {
                console.error('[EventCreate] 珥덇린 ?곗씠??濡쒕뱶 ?ㅽ뙣:', e);
            }

            function renderJudges(filter = '') {
                if (!judgesList || allEmployees.length === 0) {
                    if (judgesList) judgesList.innerHTML = '<p class="text-xs text-text-muted text-center py-2">?깅줉???꾩쭅?먯씠 ?놁뒿?덈떎.</p>';
                    return;
                }
                const keyword = filter.toLowerCase();
                const filtered = keyword
                    ? allEmployees.filter(e => (e.empnm || '').toLowerCase().includes(keyword) || (e.depnm || '').toLowerCase().includes(keyword))
                    : allEmployees;

                // 湲곗〈 泥댄겕 ?곹깭 蹂댁〈 (?섏젙 紐⑤뱶????珥덇린媛??ы븿)
                const currentChecked = Array.from(judgesList.querySelectorAll('.judge-checkbox:checked')).map(cb => cb.value);
                const existingChecked = existingJudges.map(j => {
                    // email?먯꽌 ?щ쾲 異붿텧
                    const { data: userData } = j; // j??event_judges ??
                    // ?ㅼ젣濡쒕뒗 fetchEventJudges媛 users ?뺣낫瑜?議곗씤?댁꽌 媛?몄삤誘濡?structure ?뺤씤 ?꾩슂
                    return j.users?.email?.split('@')[0];
                }).filter(Boolean);

                const checkedSet = new Set([...currentChecked, ...existingChecked]);

                judgesList.innerHTML = filtered.map(e => `
                    <label class="flex items-center gap-3 p-1.5 rounded hover:bg-white cursor-pointer transition-colors">
                        <input type="checkbox" class="judge-checkbox rounded border-gray-300 text-primary focus:ring-primary" value="${e.empno}" data-name="${e.empnm || ''}" ${checkedSet.has(e.empno) ? 'checked' : ''}>
                        <div class="flex-1 min-w-0">
                            <span class="text-sm font-medium text-text-main">${e.empnm || '?대쫫?놁쓬'}</span>
                            <span class="text-xs text-text-muted ml-2">${e.depnm || ''}</span>
                        </div>
                        <span class="text-xs px-2 py-0.5 rounded-full ${e.role === 'admin' ? 'bg-blue-50 text-blue-700' : 'bg-gray-100 text-gray-600'}">${e.role === 'admin' ? '愿由ъ옄' : '吏곸썝'}</span>
                    </label>
                `).join('');

                updateJudgeCount();
            }

            function updateJudgeCount() {
                if (!judgesList || !judgeCountEl) return;
                const checked = judgesList.querySelectorAll('.judge-checkbox:checked').length;
                judgeCountEl.textContent = `${checked}紐??좏깮`;
            }

            renderJudges();

            if (judgesList) judgesList.addEventListener('change', updateJudgeCount);
            if (judgeSearch) {
                judgeSearch.addEventListener('input', () => renderJudges(judgeSearch.value));
            }

            // ?좏깮???ъ궗???щ쾲 諛곗뿴
            function getSelectedJudgeEmpnos() {
                if (!judgesList) return [];
                return Array.from(judgesList.querySelectorAll('.judge-checkbox:checked')).map(cb => ({
                    empno: cb.value,
                    name: cb.dataset.name || ''
                }));
            }

            // ========== ?대깽???앹꽦 ???ъ궗??諛곗젙 + ?뚮┝ ==========
            async function assignAndNotifyJudges(eventId, eventTitle) {
                const selected = getSelectedJudgeEmpnos();
                if (selected.length === 0) return;

                // 1) ?꾩껜 ?ъ슜??紐⑸줉(public.users) 媛?몄삤湲?
                let allUsers = [];
                try {
                    const { data, error } = await supabaseClient.from('users').select('id, email, name');
                    if (!error) allUsers = data;
                } catch (e) { console.error(e); }

                const userMap = {};
                allUsers.forEach(u => {
                    // ?대찓?쇱뿉???щ쾲 異붿텧 (?? 22505001@opco.internal -> 22505001)
                    if (u.email) {
                        const empno = u.email.split('@')[0];
                        userMap[empno] = u.id;
                    }
                });

                let successCount = 0;
                let failCount = 0;

                for (const judge of selected) {
                    let userId = userMap[judge.empno];

                    if (!userId) {
                        console.warn(`[EventCreate] ?щ쾲 ${judge.empno} (${judge.name})? ?꾩쭅 媛?낇븯吏 ?딆븯嫄곕굹 李얠쓣 ???놁뒿?덈떎.`);
                        failCount++;
                        continue;
                    }

                    try {
                        await window.assignJudge(eventId, userId);
                        if (typeof window.createNotification === 'function') {
                            await window.createNotification(
                                userId,
                                `[?ъ궗 諛곗젙] "${eventTitle}" ?대깽?몄쓽 ?ъ궗?먮줈 諛곗젙?섏뿀?듬땲??`,
                                `event-detail.html?id=${eventId}`
                            );
                        }
                        successCount++;
                    } catch (e) {
                        console.error(`[EventCreate] ?ъ궗??諛곗젙 ?ㅽ뙣 (${judge.name}):`, e);
                        failCount++;
                    }
                }

                if (failCount > 0) {
                    const failedNames = selected.filter(j => !userMap[j.empno]).map(j => j.name).join(', ');
                    console.log(`[EventCreate] 諛곗젙 ?꾨즺: ?깃났 ${successCount}紐? ?ㅽ뙣 ${failCount}紐?(誘멸??낆옄: ${failedNames})`);
                    if (failedNames) {
                        alert(`?쇰? ?ъ궗??${failedNames})???꾩쭅 ?쒖뒪?쒖뿉 媛??濡쒓렇???섏? ?딆븘 諛곗젙?섏? ?딆븯?듬땲??\n?대떦 ?몄썝??濡쒓렇?명븳 ??愿由ъ옄 硫붾돱?먯꽌 ?ㅼ떆 諛곗젙??二쇱꽭??`);
                    }
                }
            }

            // ========== 怨듯넻 ?곗씠???섏쭛 ==========
            async function collectEventData(status) {
                const buildStoredName = (file) => {
                    const normalized = (file?.name || 'file').normalize('NFC');
                    const extIndex = normalized.lastIndexOf('.');
                    const ext = extIndex > -1 ? normalized.slice(extIndex) : '';
                    const token = (crypto?.randomUUID?.() || `${Date.now()}_${Math.random().toString(36).slice(2, 8)}`).replace(/[^a-zA-Z0-9_-]/g, '');
                    return `${Date.now()}_${token}${ext}`;
                };
                const withOriginalName = (publicUrl, originalName) => {
                    const normalized = (originalName || '').normalize('NFC');
                    return `${publicUrl}#name=${encodeURIComponent(normalized)}`;
                };
                const MAX_UPLOAD_BYTES = 50 * 1024 * 1024;
                const ALLOWED_UPLOAD_EXTS = ['pdf', 'png', 'jpg', 'jpeg', 'gif', 'webp', 'txt', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'zip', 'hwp', 'hwpx', 'dwg', 'dxf'];
                const validateUploadFile = (file) => {
                    const ext = (file.name.split('.').pop() || '').toLowerCase();
                    if (!ALLOWED_UPLOAD_EXTS.includes(ext)) {
                        return `?덉슜?섏? ?딅뒗 ?뚯씪 ?뺤떇?낅땲?? ${file.name}`;
                    }
                    if (file.size > MAX_UPLOAD_BYTES) {
                        return `50MB瑜?珥덇낵???뚯씪?낅땲?? ${file.name}`;
                    }
                    return null;
                };

                const data = {
                    title: document.getElementById('event-title').value,
                    description: document.getElementById('event-desc').value,
                    start_date: document.getElementById('start-date').value,
                    end_date: document.getElementById('end-date').value,
                    allow_file_upload: document.getElementById('allow-file').checked,
                    is_blind_judging: document.getElementById('is-blind').checked,
                    pass_criteria: collectCriteria(),
                    status: status,
                    attachments: []
                };

                // 湲고쉷?덈궡 ?뚯씪 ?낅줈??泥섎━
                const guideFileInput = document.getElementById('guide-file');
                if (guideFileInput && guideFileInput.files.length > 0) {
                    const files = Array.from(guideFileInput.files);
                    const uploadedUrls = [];

                    for (const file of files) {
                        const invalid = validateUploadFile(file);
                        if (invalid) {
                            alert(invalid);
                            continue;
                        }
                        const fileName = buildStoredName(file);
                        const filePath = `event-guides/${fileName}`;

                        try {
                            const { data: uploadData, error: uploadError } = await supabaseClient.storage
                                .from('event-attachments') // 'event-attachments' 踰꾪궥 ?ъ슜
                                .upload(filePath, file);

                            if (uploadError) throw uploadError;

                            const { data: { publicUrl } } = supabaseClient.storage
                                .from('event-attachments')
                                .getPublicUrl(filePath);

                            uploadedUrls.push(withOriginalName(publicUrl, file.name));
                        } catch (err) {
                            console.error(`[EventCreate] ?뚯씪 ?낅줈???ㅽ뙣 (${file.name}):`, err);
                            if (!confirm(`'${file.name}' ?뚯씪 ?낅줈?쒖뿉 ?ㅽ뙣?덉뒿?덈떎. ???뚯씪???쒖쇅?섍퀬 怨꾩냽?섏떆寃좎뒿?덇퉴?`)) {
                                throw new Error('?뚯씪 ?낅줈??以묐떒');
                            }
                        }
                    }
                    data.attachments = uploadedUrls;
                }

                return data;
            }

            // ========== ?섏젙 紐⑤뱶 ??湲곗〈 ?곗씠??梨꾩슦湲?==========
            if (isEditMode) {
                try {
                    const event = await window.fetchEventDetails(eventId);
                    if (event) {
                        document.getElementById('event-title').value = event.title || '';
                        document.getElementById('event-desc').value = event.description || '';
                        document.getElementById('start-date').value = event.start_date || '';
                        document.getElementById('end-date').value = event.end_date || '';

                        // ?ㅼ젙媛?
                        const allowFile = document.getElementById('allow-file');
                        const isBlind = document.getElementById('is-blind');
                        const toggleAllowFile = document.getElementById('toggle-allow-file');
                        const toggleIsBlind = document.getElementById('toggle-is-blind');

                        if (event.allow_file_upload !== allowFile.checked) {
                            toggleAllowFile.click();
                        }
                        if (event.is_blind_judging !== isBlind.checked) {
                            toggleIsBlind.click();
                        }

                        // ?ъ궗 湲곗?
                        if (event.pass_criteria && event.pass_criteria.length > 0) {
                            criteriaList.innerHTML = '';
                            event.pass_criteria.forEach(c => addCriteriaItem(c.name));
                        }
                    }
                } catch (err) {
                    console.error('[EventEdit] 湲곗〈 ?곗씠??濡쒕뱶 ?ㅻ쪟:', err);
                }
            }

            // ========== ?대깽???깅줉 怨듯넻 ?⑥닔 ==========
            async function submitEvent(status, btn, originalText) {
                if (!document.getElementById('event-title').value) { alert('?대깽???쒕ぉ???낅젰?댁＜?몄슂.'); return; }

                btn.textContent = status === 'draft' ? '저장 중...' : (isEditMode ? '수정 중...' : '등록 중...');
                btn.disabled = true;

                try {
                    const data = await collectEventData(status);

                    if (typeof window.createEvent !== 'function' || typeof window.updateEvent !== 'function') {
                        throw new Error('?쒖뒪??珥덇린??以묒엯?덈떎. ?좎떆 ???ㅼ떆 ?쒕룄??二쇱꽭??');
                    }

                    let result;
                    if (isEditMode) {
                        result = await window.updateEvent(eventId, data);
                    } else {
                        result = await window.createEvent(data);
                    }

                    if (result.error) {
                        alert((isEditMode ? '수정' : (status === 'draft' ? '저장' : '등록')) + ' 실패: ' + (result.error.message || result.error));
                        btn.textContent = originalText;
                        btn.disabled = false;
                    } else {
                        const targetId = isEditMode ? eventId : (result.data ? result.data.id : null);
                        if (targetId) {
                            if (isEditMode) {
                                // 湲곗〈 ?ъ궗??珥덇린?????ㅼ떆 諛곗젙
                                if (typeof window.clearEventJudges === 'function') {
                                    await window.clearEventJudges(targetId);
                                }
                            }
                            await assignAndNotifyJudges(targetId, data.title);
                        }
                        alert(isEditMode ? '이벤트가 성공적으로 수정되었습니다.' : (status === 'draft' ? '초안이 저장되었습니다.' : '이벤트가 성공적으로 생성되었습니다.'));
                        window.location.href = isEditMode ? `event-detail.html?id=${eventId}` : 'dashboard.html';
                    }
                } catch (err) {
                    if (err.message !== '?뚯씪 ?낅줈??以묐떒') {
                        console.error('[EventSubmit] Error:', err);
                        alert('?대깽??泥섎━ 以??ㅻ쪟: ' + err.message);
                    }
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            }

            if (btnSaveDraft) btnSaveDraft.addEventListener('click', () => submitEvent('draft', btnSaveDraft, '초안 저장'));
            if (btnContinue) btnContinue.addEventListener('click', () => submitEvent('active', btnContinue, '이벤트 등록 및 대시보드 이동'));

            // ?リ린(X) 踰꾪듉
            const btnClose = document.querySelector('.text-text-muted.hover\\:text-text-main');
            if (btnClose) {
                btnClose.addEventListener('click', () => { window.location.href = 'dashboard.html'; });
            }
        });
    </script>
</body>

</html>

